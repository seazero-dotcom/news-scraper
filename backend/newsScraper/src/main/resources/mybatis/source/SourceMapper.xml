<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.doubledowninteractive.news.source.repository.SourceMapper">
    <resultMap id="SourceMap" type="com.doubledowninteractive.news.source.domain.Source">
        <id property="id" column="id"/>
        <result property="code" column="code"/>
        <result property="name" column="name"/>
        <result property="baseUrl" column="base_url"/>
        <result property="enabled" column="enabled"/>
        <result property="createdAt" column="created_at"/>
        <result property="collector" column="collector"/>  <!-- ✅ -->
        <result property="params" column="params"/>        <!-- ✅ -->
    </resultMap>


    <select id="findAll" resultMap="SourceMap">
        SELECT * FROM sources ORDER BY id DESC
    </select>

    <select id="findById" parameterType="long" resultMap="SourceMap">
        SELECT * FROM sources WHERE id = #{id}
    </select>

    <!-- 스케줄러에서 쓰는 조회: enabled=1 조건 포함 -->
    <select id="findByCode" parameterType="string" resultMap="SourceMap">
        SELECT * FROM sources WHERE code = #{code} AND enabled = 1
    </select>

    <insert id="insert">
        INSERT INTO sources(code, name, base_url, enabled, collector, params)
        VALUES(#{code}, #{name}, #{baseUrl}, 1, #{collector}, #{params})
    </insert>

    <update id="updateEnabled">
        UPDATE sources SET enabled = #{enabled} WHERE id = #{id}
    </update>

    <update id="update">
        UPDATE sources
        <set>
            <if test="name != null"> name = #{name}, </if>
            <if test="baseUrl != null"> base_url = #{baseUrl}, </if>
            <if test="collector != null"> collector = #{collector}, </if>
            <if test="params != null"> params = #{params}, </if>
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM sources WHERE id = #{id}
    </delete>

    <select id="findAllEnabled" resultMap="SourceMap">
        SELECT * FROM sources WHERE enabled = 1 ORDER BY id ASC
    </select>

</mapper>
